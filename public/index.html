<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crest Market Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14;
      --text:#e6edf3;
      --muted:#a9b4c0;
      --line:rgba(255,255,255,.08);
      --green:#22c55e;
      --red:#ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(900px 600px at 20% -10%, rgba(34,197,94,.10), transparent 60%),
                  radial-gradient(900px 600px at 80% -10%, rgba(59,130,246,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,15,20,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .ticker{
      max-width:1200px; margin:0 auto;
      padding:10px 18px;
      display:flex; gap:10px; overflow:auto; scrollbar-width:thin;
    }
    .ticker::-webkit-scrollbar{height:8px}
    .ticker::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14); border-radius:999px}
    .tick{
      flex:0 0 auto;
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      min-width:230px;
    }
    .sym{font-weight:900; letter-spacing:.4px; font-size:13px}
    .px{color:var(--muted); font-size:13px}
    .chg{
      margin-left:auto;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      min-width:92px;
      text-align:center;
    }
    .up{color:var(--green)}
    .down{color:var(--red)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px 18px 26px}
    .topControls{
      max-width:1200px; margin:0 auto;
      padding:0 18px 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .btn{
      font-size:12px; padding:10px 12px;
      border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer; font-weight:900;
    }
    .btn:hover{background: rgba(255,255,255,.07)}
    .searchWrap{max-width:1200px; margin:10px auto 0; padding:0 18px 12px;}
    .searchRow{display:flex; gap:10px;}
    .searchRow input{
      flex:1;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .grid{
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:14px;
      align-items:start;
      margin-top:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .title{font-weight:900; font-size:13px; letter-spacing:.35px; color:#dbe7f3}
    .pillBtn{
      font-size:12px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer; font-weight:900;
    }
    .pillBtn:hover{background: rgba(255,255,255,.07)}
    .cardBody{padding:12px}
    .list{display:grid; gap:10px}
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .row:hover{background: rgba(255,255,255,.05)}
    .rowLeft{display:flex; flex-direction:column; gap:2px}
    .rowLeft b{font-size:13px; letter-spacing:.3px}
    .rowLeft span{font-size:12px; color:var(--muted)}
    .badge{
      font-weight:900; font-size:12px;
      padding:4px 8px;
      border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      min-width:90px;
      text-align:center;
      cursor:pointer;
    }
    .story h2{margin:0; font-size:16px; letter-spacing:-.2px}
    .story p{margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.5}
    .liveTag{
      display:inline-flex; align-items:center; gap:7px;
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color:#d9ffe6;
    }
    .dot{width:7px; height:7px; border-radius:999px; background:var(--green); box-shadow:0 0 0 6px rgba(34,197,94,.12)}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    .kvc{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius:12px; padding:10px 10px}
    .kvc .k{color:var(--muted); font-size:12px}
    .kvc .v{margin-top:4px; font-weight:900}
    .newsList{display:grid; gap:10px}
    .newsItem{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background: rgba(255,255,255,.03)}
    .newsMeta{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
    .time{font-size:12px; color:var(--muted)}
    .tag{font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.12); color:#ffe6b7;}
    .newsItem b{display:block; font-size:13px; line-height:1.35}
    .newsItem a{color:var(--text); text-decoration:none}
    .newsItem a:hover{text-decoration:underline}
    .status{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35}
    .status b{color:var(--text)}
    .err{color:#ffb4b4}
    @media (max-width: 1060px){ .grid{grid-template-columns: 280px 1fr} .grid > .right{grid-column: 1 / -1} }
    @media (max-width: 760px){ .grid{grid-template-columns: 1fr} }
  
    /* Insight (Robinhood-style narrative) */
    .insightTitle{
      font-size:28px;
      line-height:1.1;
      margin:0;
      letter-spacing:-.5px;
      font-weight:950;
    }
    .insightTitle.up{ color: var(--green); }
    .insightTitle.down{ color: #f97316; } /* orange like screenshots */
    .insightSub{
      margin-top:8px;
      color: var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .insightStack{
      margin-top:14px;
      display:grid;
      gap:14px;
    }
    .insightBlock{
      display:grid;
      grid-template-columns: 10px 1fr;
      gap:10px;
      align-items:start;
    }
    .insightRail{
      width:4px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      height:100%;
      min-height:48px;
      margin-top:4px;
    }
    .insightHeading{
      color:#f97316;
      font-weight:950;
      letter-spacing:.2px;
      margin:0;
      font-size:14px;
    }
    .insightText{
      margin:8px 0 0;
      color: rgba(230,237,243,.92);
      font-size:13px;
      line-height:1.55;
    }

</style>
</head>
<body>
  <div class="topbar">
    <div class="ticker">
      <div class="tick"><span class="sym">DOW</span><span class="px" id="dowPx">—</span><span class="chg" id="dowChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">NASDAQ</span><span class="px" id="nasPx">—</span><span class="chg" id="nasChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">S&P 500</span><span class="px" id="spPx">—</span><span class="chg" id="spChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">RUSSELL 2000</span><span class="px" id="rutPx">—</span><span class="chg" id="rutChg" title="Click to toggle % / $ change">—</span></div>
    </div>
    <div class="ticker" style="border-top:1px solid var(--line);">
      <div class="tick"><span class="sym">GOLD</span><span class="px" id="goldPx">—</span><span class="chg" id="goldChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">SILVER</span><span class="px" id="silverPx">—</span><span class="chg" id="silverChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">OIL</span><span class="px" id="oilPx">—</span><span class="chg" id="oilChg" title="Click to toggle % / $ change">—</span></div>
      <div class="tick"><span class="sym">NAT GAS</span><span class="px" id="gasPx">—</span><span class="chg" id="gasChg" title="Click to toggle % / $ change">—</span></div>
    </div>
    <div class="topControls">
      <span id="marketStatus" class="liveTag" style="border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); color: var(--text);">
        <span class="dot" id="marketDot" style="background: rgba(148,163,184,1); box-shadow: 0 0 0 6px rgba(148,163,184,.12);"></span>
        <span id="marketText">Market: —</span>
      </span>
      <button class="btn" id="refreshBtn">Refresh now</button>
    </div>
    <div class="searchWrap">
      <div class="searchRow">
        <input id="tickerSearch" placeholder="Search ticker (ex: AAPL, TSLA, NVDA)" />
        <button id="tickerBtn" class="btn">Open</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="singleView" style="display:none;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;">
      <button class="btn" id="backBtn">← Back</button>
      <div style="font-weight:900; letter-spacing:.4px;">Single Stock</div>
      <div style="width:80px;"></div>
    </div>
    <div class="card">
      <div class="cardHeader">
        <div class="title" id="singleTitle">—</div>
        <div class="liveTag"><span class="dot"></span> LIVE</div>
      </div>
      <div class="cardBody story">
        <p id="singleSub" style="margin-top:0;color:var(--muted);">—</p>
        <div class="kv">
          <div class="kvc"><div class="k">Price</div><div class="v" id="singlePrice">—</div></div>
          <div class="kvc"><div class="k">Change</div><div class="v" id="singleChange">—</div></div>
          <div class="kvc"><div class="k">Day range</div><div class="v" id="singleRange">—</div></div>
          <div class="kvc"><div class="k">Prev close</div><div class="v" id="singlePrev">—</div></div>
        </div>

        <div style="margin-top:12px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02); padding:10px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:900; font-size:12px; letter-spacing:.35px; color:#dbe7f3;">Price chart (Stooq)</div>

              <div id="singleHorizonTabs" style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="pillBtn" data-h="quick">Quick</button>
                <button class="pillBtn" data-h="long">Horizon</button>
              </div>

              <div id="singleTfBtnsQuick" style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="pillBtn" data-tf="1">1D</button>
                <button class="pillBtn" data-tf="7">7D</button>
                <button class="pillBtn" data-tf="30">30D</button>
                <button class="pillBtn" data-tf="90">90D</button>
                <button class="pillBtn" data-tf="252">1Y</button>
              </div>

              <div id="singleTfBtnsLong" style="display:none; gap:6px; flex-wrap:wrap;">
                <button class="pillBtn" data-tf="756">3Y</button>
                <button class="pillBtn" data-tf="1260">5Y</button>
                <button class="pillBtn" data-tf="2520">10Y</button>
                <button class="pillBtn" data-tf="3780">15Y</button>
              </div>

              <button class="pillBtn" id="singleSma20Btn">SMA 20: Off</button>
              <button class="pillBtn" id="singleSma50Btn">SMA 50: Off</button>
              <button class="pillBtn" id="singleSma200Btn">SMA 200: Off</button>
            </div>
            <div class="status" id="singleChartStatus" style="margin:0;"></div>
          </div>
          <canvas id="singlePriceChart" style="width:100%; height:260px; display:block;"></canvas>
          <div class="status" id="singleMoveSummary" style="margin-top:10px;"></div>
        </div>

        
        <div style="margin-top:12px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02); padding:12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div class="title">Insight</div>
            <button class="pillBtn" id="singleRefreshInsight">Refresh</button>
          </div>
          <div id="singleInsightWrap" style="margin-top:10px;">
            <h3 class="insightTitle" id="singleInsightTitle">—</h3>
            <div class="insightSub" id="singleInsightSub">—</div>
            <div class="insightStack" id="singleInsightBlocks"></div>
          </div>
        </div>

        <div class="status" id="singleStatus"></div>
      </div>
    </div>
  </div>

  <div class="wrap" id="dashboardView">
    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="title">Watchlist</div>
          <button class="pillBtn" id="removeBtn">Remove</button>
        </div>
        <div class="cardBody">
          <div class="list" id="watchlist"></div>
          <div class="status" id="wlStatus">Tip: click a row to open. Shift-click to mark then Remove.</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="title">Selected</div>
          <div class="liveTag"><span class="dot"></span> LIVE</div>
        </div>
        <div class="cardBody story">
          <h2 id="selTitle">Select a ticker</h2>
          <p id="selSub">Use the search bar or click a symbol in the watchlist.</p>

          <div class="kv">
            <div class="kvc"><div class="k">Price</div><div class="v" id="selPrice">—</div></div>
            <div class="kvc"><div class="k">Change</div><div class="v" id="selChange">—</div></div>
            <div class="kvc"><div class="k">Day range</div><div class="v" id="selRange">—</div></div>
            <div class="kvc"><div class="k">Prev close</div><div class="v" id="selPrev">—</div></div>
          </div>

          <div style="margin-top:12px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02); padding:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap;">
              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <div style="font-weight:900; font-size:12px; letter-spacing:.35px; color:#dbe7f3;">Price chart (Stooq)</div>

                <div id="horizonTabs" style="display:flex; gap:6px; flex-wrap:wrap;">
                  <button class="pillBtn" data-h="quick">Quick</button>
                  <button class="pillBtn" data-h="long">Horizon</button>
                </div>

                <div id="tfBtnsQuick" style="display:flex; gap:6px; flex-wrap:wrap;">
                  <button class="pillBtn" data-tf="1">1D</button>
                  <button class="pillBtn" data-tf="7">7D</button>
                  <button class="pillBtn" data-tf="30">30D</button>
                  <button class="pillBtn" data-tf="90">90D</button>
                  <button class="pillBtn" data-tf="252">1Y</button>
                </div>

                <div id="tfBtnsLong" style="display:none; gap:6px; flex-wrap:wrap;">
                  <button class="pillBtn" data-tf="756">3Y</button>
                  <button class="pillBtn" data-tf="1260">5Y</button>
                  <button class="pillBtn" data-tf="2520">10Y</button>
                  <button class="pillBtn" data-tf="3780">15Y</button>
                </div>

                <button class="pillBtn" id="sma20Btn">SMA 20: Off</button>
                <button class="pillBtn" id="sma50Btn">SMA 50: Off</button>
                <button class="pillBtn" id="sma200Btn">SMA 200: Off</button>
              </div>
              <div class="status" id="chartStatus" style="margin:0;"></div>
            </div>
            <canvas id="priceChart" style="width:100%; height:220px; display:block;"></canvas>
          <div class="status" id="selMoveSummary" style="margin-top:10px;"></div>
          </div>

          
          <div style="margin-top:12px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02); padding:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="title">Insight</div>
              <button class="pillBtn" id="refreshInsight">Refresh</button>
            </div>
            <div id="insightWrap" style="margin-top:10px;">
              <h3 class="insightTitle" id="insightTitle">Select a ticker to see what&#39;s moving it.</h3>
              <div class="insightSub" id="insightSub">—</div>
              <div class="insightStack" id="insightBlocks"></div>
            </div>
          </div>

          <div class="status" id="selStatus"></div>
        </div>
      </div>

      <div class="card right">
        <div class="cardHeader">
          <div class="title">Market News</div>
          <button class="pillBtn" id="refreshNews">Refresh</button>
        </div>
<button class="pillBtn" id="refreshBreaking">Refresh</button>
          </div>
          <div id="breaking" class="newsList"></div>
          <div class="status" id="breakingStatus" style="margin-top:10px;"></div>
        </div>
<div class="cardBody">

          <div style="margin-bottom:12px; padding:10px 10px; border-radius:12px; border:1px solid rgba(239,68,68,.30); background: rgba(239,68,68,.06);">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
              <div class="title" style="display:flex; align-items:center; gap:8px;">
                <span style="display:inline-flex; width:8px; height:8px; border-radius:999px; background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.14);"></span>
                Breaking (Watchlist)
              </div>
              <button class="pillBtn" id="refreshBreaking">Refresh</button>
            </div>
            <div id="breaking" class="newsList"></div>
            <div class="status" id="breakingStatus" style="margin-top:8px;"></div>
          </div>


          <div class="newsList" id="news"></div>
          <div class="status" id="newsStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const FINNHUB_TOKEN = "d68eb5hr01qq5rjf8kbgd68eb5hr01qq5rjf8kc0";
    const API_BASE = "https://finnhub.io/api/v1";
    const INDEX_PROXIES = { dow: "DIA", nas: "QQQ", sp: "SPY", rut: "IWM" };
    const COMMODITY_PROXIES = { gold: "GLD", silver: "SLV", oil: "USO", gas: "UNG" };
    const DEFAULT_WATCHLIST = ["AAPL","TSLA","NVDA","MSFT","AMZN","META"];

    // Chart controls (time horizon + timeframe + SMA toggles)
    let chartHorizon = localStorage.getItem("crest_chart_horizon") || "quick"; // "quick" | "long"
    let chartTimeframe = localStorage.getItem("crest_chart_tf") || "90"; // "1","7","30","90","252","756","1260","2520","3780"
    let sma20Enabled  = (localStorage.getItem("crest_sma20")  || "0") === "1";
    let sma50Enabled  = (localStorage.getItem("crest_sma50")  || "0") === "1";
    let sma200Enabled = (localStorage.getItem("crest_sma200") || "0") === "1";

    function getActiveTimeframe(){ return chartTimeframe; }
    function setActiveTimeframe(tf){
      chartTimeframe = String(tf);
      localStorage.setItem("crest_chart_tf", chartTimeframe);
      updateTfButtonsUI();
    }
    function setHorizon(h){
      chartHorizon = (h === "long") ? "long" : "quick";
      localStorage.setItem("crest_chart_horizon", chartHorizon);
      updateHorizonUI();
      updateTfButtonsUI();
    }

    function setSma(period, enabled){
      const v = !!enabled;
      if(period === 20){ sma20Enabled = v; localStorage.setItem("crest_sma20", v ? "1":"0"); }
      if(period === 50){ sma50Enabled = v; localStorage.setItem("crest_sma50", v ? "1":"0"); }
      if(period === 200){ sma200Enabled = v; localStorage.setItem("crest_sma200", v ? "1":"0"); }
      updateSmaButtonsUI();
    }

    // State
    let watchlist = [];
    let selected = null;
    let selectedForRemoval = null;
    const profileCache = new Map();
    let displayMode = localStorage.getItem("crest_change_mode") || "percent";

    // News throttle
    let lastNewsAt = 0;
    const NEWS_REFRESH_MS = 5 * 60 * 1000;

    // DOM
    const refreshBtn = document.getElementById("refreshBtn");
    const marketStatusEl = document.getElementById("marketStatus");
    const marketTextEl = document.getElementById("marketText");
    const marketDotEl = document.getElementById("marketDot");

    const watchlistEl = document.getElementById("watchlist");
    const wlStatus = document.getElementById("wlStatus");
    const removeBtn = document.getElementById("removeBtn");

    const tickerInput = document.getElementById("tickerSearch");
    const tickerBtn = document.getElementById("tickerBtn");

    const selTitle = document.getElementById("selTitle");
    const selSub = document.getElementById("selSub");
    const selPrice = document.getElementById("selPrice");
    const selChange = document.getElementById("selChange");
    const selRange = document.getElementById("selRange");
    const selPrev = document.getElementById("selPrev");
    const selStatus = document.getElementById("selStatus");

    const chartCanvas = document.getElementById("priceChart");
    const chartStatusEl = document.getElementById("chartStatus");

    const horizonTabs = document.getElementById("horizonTabs");
    const tfBtnsQuick = document.getElementById("tfBtnsQuick");
    const tfBtnsLong  = document.getElementById("tfBtnsLong");
    const sma20Btn = document.getElementById("sma20Btn");
    const sma50Btn = document.getElementById("sma50Btn");
    const sma200Btn = document.getElementById("sma200Btn");

    const newsEl = document.getElementById("news");
    const newsStatus = document.getElementById("newsStatus");
    const refreshNewsBtn = document.getElementById("refreshNews");

    const dashboardView = document.getElementById("dashboardView");
    const singleView = document.getElementById("singleView");
    const backBtn = document.getElementById("backBtn");

    const singleTitle = document.getElementById("singleTitle");
    const singleSub = document.getElementById("singleSub");
    const singlePrice = document.getElementById("singlePrice");
    const singleChange = document.getElementById("singleChange");
    const singleRange = document.getElementById("singleRange");
    const singlePrev = document.getElementById("singlePrev");
    const singleStatus = document.getElementById("singleStatus");
    const singleChartCanvas = document.getElementById("singlePriceChart");
    const singleChartStatusEl = document.getElementById("singleChartStatus");

    const singleHorizonTabs = document.getElementById("singleHorizonTabs");
    const singleTfBtnsQuick = document.getElementById("singleTfBtnsQuick");
    const singleTfBtnsLong  = document.getElementById("singleTfBtnsLong");
    const singleSma20Btn = document.getElementById("singleSma20Btn");
    const singleSma50Btn = document.getElementById("singleSma50Btn");
    const singleSma200Btn = document.getElementById("singleSma200Btn");

    const idxEls = {
      dow: { px: document.getElementById("dowPx"), chg: document.getElementById("dowChg") },
      nas: { px: document.getElementById("nasPx"), chg: document.getElementById("nasChg") },
      sp:  { px: document.getElementById("spPx"),  chg: document.getElementById("spChg")  },
      rut: { px: document.getElementById("rutPx"), chg: document.getElementById("rutChg") }
    };
    const comEls = {
      gold: { px: document.getElementById("goldPx"), chg: document.getElementById("goldChg") },
      silver: { px: document.getElementById("silverPx"), chg: document.getElementById("silverChg") },
      oil: { px: document.getElementById("oilPx"), chg: document.getElementById("oilChg") },
      gas: { px: document.getElementById("gasPx"), chg: document.getElementById("gasChg") }
    };

    // Utils
    function fmtNum(n){
      if(n === null || n === undefined || Number.isNaN(Number(n))) return "—";
      return Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 });
    }
    function fmtPct(p){
      if(p === null || p === undefined || Number.isNaN(Number(p))) return "—";
      const v = Number(p);
      return `${v >= 0 ? "+" : ""}${v.toFixed(2)}%`;
    }
    function pctFromQuote(q){ return Number(q?.dp ?? 0); }
    function setUpDown(el, v){ el.classList.toggle("up", v >= 0); el.classList.toggle("down", v < 0); }
    function chgText(q){ return q ? ((displayMode === "percent") ? fmtPct(q.dp) : fmtNum(q.d)) : "—"; }

    function toggleDisplayMode(){
      displayMode = (displayMode === "percent") ? "change" : "percent";
      localStorage.setItem("crest_change_mode", displayMode);
      refreshAll();
    }

    function loadState(){
      try{
        watchlist = JSON.parse(localStorage.getItem("crest_watchlist") || "null") || DEFAULT_WATCHLIST.slice();
      }catch{
        watchlist = DEFAULT_WATCHLIST.slice();
      }
      selected = localStorage.getItem("crest_selected") || watchlist[0] || null;
    }
    function saveState(){
      localStorage.setItem("crest_watchlist", JSON.stringify(watchlist));
      localStorage.setItem("crest_selected", selected || "");
    }

    function getUrlSymbol(){
      const u = new URL(window.location.href);
      const s = (u.searchParams.get("symbol") || "").trim().toUpperCase();
      return s || null;
    }
    function setUrlSymbol(sym){
      const u = new URL(window.location.href);
      if(sym) u.searchParams.set("symbol", sym);
      else u.searchParams.delete("symbol");
      window.history.pushState({}, "", u.toString());
      handleRoute();
    }

    // Finnhub
    async function fetchJson(path, params = {}){
      const url = new URL(API_BASE + path);
      for (const [k,v] of Object.entries(params)) url.searchParams.set(k, v);
      url.searchParams.set("token", FINNHUB_TOKEN);

      const res = await fetch(url.toString(), { headers: { "accept": "application/json" } });
      let bodyText = "";
      let bodyJson = null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      try{
        if(ct.includes("application/json")){
          bodyJson = await res.json();
          bodyText = bodyJson ? JSON.stringify(bodyJson) : "";
        } else {
          bodyText = await res.text();
        }
      }catch(_){}

      if(!res.ok){
        const msg = bodyJson?.error || bodyJson?.message || bodyText || `${res.status} ${res.statusText}`;
        throw new Error(`${res.status} ${res.statusText}: ${msg}`);
      }
      return bodyJson ?? (bodyText ? JSON.parse(bodyText) : null);
    }

    async function getQuote(symbol){ return fetchJson("/quote", { symbol: String(symbol).toUpperCase() }); }
    async function getProfile2(symbol){
      const s = String(symbol).toUpperCase();
      if(profileCache.has(s)) return profileCache.get(s);
      const p = await fetchJson("/stock/profile2", { symbol: s });
      profileCache.set(s, p);
      return p;
    }

    // Stooq daily via Jina
    function stooqSymbol(sym){ return `${String(sym||"").trim().toLowerCase()}.us`; }
    function stooqUrl(sym){
      const s = stooqSymbol(sym);
      const raw = `https://stooq.com/q/d/l/?s=${encodeURIComponent(s)}&i=d`;
      return `https://r.jina.ai/${raw}`;
    }
    function stooqCacheKey(sym){ return `crest_stooq_${String(sym||"").toUpperCase()}`; }

    async function fetchStooqDaily(sym, limit = 4200){
      const key = stooqCacheKey(sym);
      try{
        const cached = JSON.parse(localStorage.getItem(key) || "null");
        if(cached && cached.t && (Date.now() - cached.t) < 6*60*60*1000 && Array.isArray(cached.rows)){
          return cached.rows.slice(-limit);
        }
      }catch(_){}

      const res = await fetch(stooqUrl(sym));
      if(!res.ok) throw new Error(`Stooq ${res.status} ${res.statusText}`);
      const text = await res.text();

      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const headerIdx = lines.findIndex(l => /^Date,Open,High,Low,Close,Volume/i.test(l));
      const csvLines = headerIdx >= 0 ? lines.slice(headerIdx) : lines;

      const out = [];
      for(let i=1;i<csvLines.length;i++){
        const parts = csvLines[i].split(",");
        if(parts.length < 6) continue;
        const date = parts[0];
        const close = Number(parts[4]);
        if(!date || !Number.isFinite(close)) continue;
        out.push({ date, close });
      }

      try{ localStorage.setItem(key, JSON.stringify({ t: Date.now(), rows: out })); }catch(_){}
      return out.slice(-limit);
    }

    // Horizon UI
    function updateHorizonUI(){
      const showLong = chartHorizon === "long";
      if(tfBtnsQuick) tfBtnsQuick.style.display = showLong ? "none" : "flex";
      if(tfBtnsLong) tfBtnsLong.style.display = showLong ? "flex" : "none";
      if(singleTfBtnsQuick) singleTfBtnsQuick.style.display = showLong ? "none" : "flex";
      if(singleTfBtnsLong) singleTfBtnsLong.style.display = showLong ? "flex" : "none";

      const setActive = (wrap) => {
        if(!wrap) return;
        [...wrap.querySelectorAll("button[data-h]")].forEach(b => {
          const on = String(b.dataset.h) === String(chartHorizon);
          b.style.borderColor = on ? "rgba(34,197,94,.55)" : "var(--line)";
          b.style.background = on ? "rgba(34,197,94,.12)" : "rgba(255,255,255,.04)";
        });
      };
      setActive(horizonTabs);
      setActive(singleHorizonTabs);
    }

    // Timeframe buttons UI (across both groups)
    function updateTfButtonsUI(){
      const allWraps = [tfBtnsQuick, tfBtnsLong, singleTfBtnsQuick, singleTfBtnsLong];
      allWraps.forEach(wrap => {
        if(!wrap) return;
        [...wrap.querySelectorAll("button[data-tf]")].forEach(b => {
          const on = String(b.dataset.tf) === String(chartTimeframe);
          b.style.borderColor = on ? "rgba(34,197,94,.55)" : "var(--line)";
          b.style.background = on ? "rgba(34,197,94,.12)" : "rgba(255,255,255,.04)";
        });
      });
    }

    function updateSmaButtonsUI(){
      const t20 = `SMA 20: ${sma20Enabled ? "On" : "Off"}`;
      const t50 = `SMA 50: ${sma50Enabled ? "On" : "Off"}`;
      const t200 = `SMA 200: ${sma200Enabled ? "On" : "Off"}`;

      if(sma20Btn) sma20Btn.textContent = t20;
      if(sma50Btn) sma50Btn.textContent = t50;
      if(sma200Btn) sma200Btn.textContent = t200;

      if(singleSma20Btn) singleSma20Btn.textContent = t20;
      if(singleSma50Btn) singleSma50Btn.textContent = t50;
      if(singleSma200Btn) singleSma200Btn.textContent = t200;
    }

    function wireChartControls(){
      const wireHorizon = (wrap) => {
        if(!wrap) return;
        wrap.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-h]");
          if(!btn) return;
          setHorizon(btn.dataset.h);
          const sym = getUrlSymbol();
          if(sym) renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
          else if(selected) renderDailyChart(selected, chartCanvas, chartStatusEl);
        });
      };

      const wireTf = (wrap) => {
        if(!wrap) return;
        wrap.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-tf]");
          if(!btn) return;
          setActiveTimeframe(btn.dataset.tf);
          const sym = getUrlSymbol();
          if(sym) renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
          else if(selected) renderDailyChart(selected, chartCanvas, chartStatusEl);
        });
      };

      wireHorizon(horizonTabs);
      wireHorizon(singleHorizonTabs);

      wireTf(tfBtnsQuick);
      wireTf(tfBtnsLong);
      wireTf(singleTfBtnsQuick);
      wireTf(singleTfBtnsLong);

      const toggle20 = () => { setSma(20, !sma20Enabled); rerenderChart(); };
      const toggle50 = () => { setSma(50, !sma50Enabled); rerenderChart(); };
      const toggle200 = () => { setSma(200, !sma200Enabled); rerenderChart(); };

      if(sma20Btn) sma20Btn.addEventListener("click", toggle20);
      if(sma50Btn) sma50Btn.addEventListener("click", toggle50);
      if(sma200Btn) sma200Btn.addEventListener("click", toggle200);

      if(singleSma20Btn) singleSma20Btn.addEventListener("click", toggle20);
      if(singleSma50Btn) singleSma50Btn.addEventListener("click", toggle50);
      if(singleSma200Btn) singleSma200Btn.addEventListener("click", toggle200);

      updateHorizonUI();
      updateTfButtonsUI();
      updateSmaButtonsUI();
    }

    function rerenderChart(){
      const sym = getUrlSymbol();
      if(sym) renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
      else if(selected) renderDailyChart(selected, chartCanvas, chartStatusEl);
    }

    // Market status
    function isMarketOpenNY(){
      try{
        const now = new Date();
        const parts = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          weekday: "short",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        }).formatToParts(now);
        const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
        const wd = map.weekday;
        const h = Number(map.hour);
        const m = Number(map.minute);
        const minutes = h*60 + m;
        const isWeekday = ["Mon","Tue","Wed","Thu","Fri"].includes(wd);
        return isWeekday && minutes >= (9*60+30) && minutes < (16*60);
      }catch(_){
        return false;
      }
    }
    function updateMarketStatus(){
      const open = isMarketOpenNY();
      if(!marketTextEl || !marketDotEl) return;
      marketTextEl.textContent = open ? "Market: OPEN" : "Market: CLOSED";
      marketDotEl.style.background = open ? "var(--green)" : "rgba(148,163,184,1)";
      marketDotEl.style.boxShadow = open ? "0 0 0 6px rgba(34,197,94,.12)" : "0 0 0 6px rgba(148,163,184,.12)";
      if(marketStatusEl){
        marketStatusEl.style.borderColor = open ? "rgba(34,197,94,.35)" : "rgba(255,255,255,.14)";
        marketStatusEl.style.background = open ? "rgba(34,197,94,.10)" : "rgba(255,255,255,.04)";
      }
    }

    // Canvas chart
    function resizeCanvas(canvas, ctx){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(rect.width * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      return { W: rect.width, H: rect.height };
    }

    function smaSeries(values, period){
      if(!values || values.length < period) return null;
      const out = new Array(values.length).fill(null);
      let sum = 0;
      for(let i=0;i<values.length;i++){
        sum += values[i];
        if(i >= period) sum -= values[i-period];
        if(i >= period-1) out[i] = sum/period;
      }
      return out;
    }

    function drawLineChart(canvas, values, sma20, sma50, sma200){
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      const { W, H } = resizeCanvas(canvas, ctx);
      ctx.clearRect(0,0,W,H);

      const padL=54,padR=16,padT=12,padB=22;
      const innerW=W-padL-padR, innerH=H-padT-padB;

      ctx.font="12px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.textBaseline="middle";

      if(!values || values.length < 2){
        ctx.fillStyle="rgba(169,180,192,0.9)";
        ctx.fillText("No data yet…", 10, 18);
        return;
      }

      let minY = Math.min(...values), maxY = Math.max(...values);
      if(minY === maxY){ minY -= 1; maxY += 1; }

      // Grid + y-axis labels
      const gridN = 4;
      ctx.strokeStyle="rgba(255,255,255,0.06)";
      ctx.fillStyle="rgba(169,180,192,0.85)";
      ctx.lineWidth=1;
      for(let i=0;i<=gridN;i++){
        const y = padT + innerH*(i/gridN);
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();

        const v = maxY - (maxY-minY)*(i/gridN);
        const label = Number(v).toLocaleString(undefined,{maximumFractionDigits:2});
        ctx.textAlign="right";
        ctx.fillText(label, padL-8, y);
      }

      // Build XY points
      const xy = values.map((val,i)=>{
        const x = padL + innerW*(i/(values.length-1));
        const y = padT + innerH*(1 - (val-minY)/(maxY-minY));
        return {x,y,val};
      });

      // Main line
      ctx.strokeStyle="rgba(34,197,94,0.95)";
      ctx.lineWidth=2;
      ctx.beginPath();
      xy.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
      ctx.stroke();

      // Helper to draw SMA
      function drawSMA(series, stroke, width, dash){
        if(!series || series.length < 2) return;
        ctx.strokeStyle = stroke;
        ctx.lineWidth = width;
        ctx.setLineDash(dash || []);
        ctx.beginPath();
        let started=false;
        series.forEach((v,i)=>{
          if(v == null) return;
          const x = padL + innerW*(i/(series.length-1));
          const y = padT + innerH*(1 - (v-minY)/(maxY-minY));
          if(!started){ ctx.moveTo(x,y); started=true; }
          else ctx.lineTo(x,y);
        });
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if(sma20Enabled)  drawSMA(sma20,  "rgba(230,237,243,0.55)", 1.5, []);
      if(sma50Enabled)  drawSMA(sma50,  "rgba(230,237,243,0.45)", 1.5, [4,3]);
      if(sma200Enabled) drawSMA(sma200, "rgba(230,237,243,0.35)", 1.5, [2,4]);

      // Last value tag
      const last = xy[xy.length-1];
      if(last){
        ctx.textAlign="left";
        const txt = Number(last.val).toLocaleString(undefined,{maximumFractionDigits:2});
        const tagPadX = 8;
        const tw = ctx.measureText(txt).width;
        const bx = Math.min(W - padR - (tw + tagPadX*2), last.x + 10);
        const by = Math.max(padT + 10, Math.min(H - padB - 10, last.y));

        ctx.fillStyle="rgba(11,15,20,0.85)";
        ctx.strokeStyle="rgba(255,255,255,0.14)";
        ctx.lineWidth=1;
        ctx.beginPath();
        if(ctx.roundRect) ctx.roundRect(bx, by - 12, tw + tagPadX*2, 24, 10);
        else { ctx.rect(bx, by - 12, tw + tagPadX*2, 24); }
        ctx.fill(); ctx.stroke();

        ctx.fillStyle="rgba(230,237,243,0.95)";
        ctx.fillText(txt, bx + tagPadX, by);
      }

      // Min/max labels
      const minTxt = `Min ${minY.toLocaleString(undefined,{maximumFractionDigits:2})}`;
      const maxTxt = `Max ${maxY.toLocaleString(undefined,{maximumFractionDigits:2})}`;
      ctx.fillStyle="rgba(169,180,192,0.75)";
      ctx.textAlign="left";
      ctx.fillText(maxTxt, padL, padT - 2);
      ctx.fillText(minTxt, padL, padT + innerH + 10);
    }

    async function renderDailyChart(sym, canvas, statusEl){
      if(!canvas) return;
      if(!sym){
        drawLineChart(canvas, null, null, null, null);
        if(statusEl) statusEl.textContent = "";
        return;
      }
      if(statusEl){
        statusEl.classList.remove("err");
        statusEl.textContent = "Loading…";
      }
      try{
        const dailyAll = await fetchStooqDaily(sym, 4200);
        const closesAll = dailyAll.map(r => Number(r.close)).filter(v => Number.isFinite(v));

        const tf = getActiveTimeframe();
        const n = Math.max(2, Number(tf));
        const startIndex = Math.max(0, closesAll.length - n);

        const windowCloses = closesAll.slice(startIndex);

        const sma20All = smaSeries(closesAll, 20);
        const sma50All = smaSeries(closesAll, 50);
        const sma200All = smaSeries(closesAll, 200);

        const sma20W = sma20All ? sma20All.slice(startIndex) : null;
        const sma50W = sma50All ? sma50All.slice(startIndex) : null;
        const sma200W = sma200All ? sma200All.slice(startIndex) : null;

        drawLineChart(canvas, windowCloses, sma20W, sma50W, sma200W);

        if(statusEl){
          const lastDate = dailyAll.length ? dailyAll[dailyAll.length-1].date : "";
          statusEl.innerHTML = `Stooq • <b>${lastDate}</b>`;
        }
      }catch(e){
        drawLineChart(canvas, null, null, null, null);
        if(statusEl){
          statusEl.classList.add("err");
          statusEl.textContent = `Chart error: ${e.message}`;
        }
      }
    }

    // Loaders
    async function loadTopRows(){
      await Promise.all(Object.entries(INDEX_PROXIES).map(async ([k, sym]) => {
        const q = await getQuote(sym);
        idxEls[k].px.textContent = fmtNum(q.c);
        idxEls[k].chg.textContent = chgText(q);
        idxEls[k].chg.onclick = toggleDisplayMode;
        setUpDown(idxEls[k].chg, pctFromQuote(q));
      }));

      await Promise.all(Object.entries(COMMODITY_PROXIES).map(async ([k, sym]) => {
        const q = await getQuote(sym);
        comEls[k].px.textContent = fmtNum(q.c);
        comEls[k].chg.textContent = chgText(q);
        comEls[k].chg.onclick = toggleDisplayMode;
        setUpDown(comEls[k].chg, pctFromQuote(q));
      }));
    }

    async function refreshHeader(){
      try{ await loadTopRows(); }catch(e){ console.warn("Header error:", e); }
    }

    function updateSelected(q, sym){
      if(!sym){
        selTitle.textContent = "Select a ticker";
        selSub.textContent = "Use the search bar or click a symbol in the watchlist.";
        selPrice.textContent = selChange.textContent = selRange.textContent = selPrev.textContent = "—";
        selStatus.textContent = "";
        renderDailyChart(null, chartCanvas, chartStatusEl);
        const ms = document.getElementById("selMoveSummary"); if(ms) ms.textContent = "";
        return;
      }

      const name = profileCache.get(sym)?.name || "";
      selTitle.textContent = `${sym}${name ? " — " + name : ""}`;

      if(!q){
        selSub.textContent = "No quote data yet.";
        selPrice.textContent = selChange.textContent = selRange.textContent = selPrev.textContent = "—";
        renderDailyChart(sym, chartCanvas, chartStatusEl);
        return;
      }

      selSub.textContent = "Live quote via Finnhub.";
      selPrice.textContent = fmtNum(q.c);
      const dp = pctFromQuote(q);
      selChange.textContent = `${fmtNum(q.d)} (${fmtPct(dp)})`;
      selChange.style.color = dp >= 0 ? "var(--green)" : "var(--red)";
      selRange.textContent = `${fmtNum(q.l)} – ${fmtNum(q.h)}`;
      selPrev.textContent = fmtNum(q.pc);
      const t = q.t ? new Date(q.t * 1000) : null;
      selStatus.textContent = t ? `Last update: ${t.toLocaleString()}` : "";

      renderDailyChart(sym, chartCanvas, chartStatusEl);

      // Insight
      refreshInsightForSelected();
    }

    async function loadQuotesForWatchlist(){
      const syms = watchlist.map(s => s.toUpperCase());
      const results = await Promise.all(syms.map(async s => {
        try { return { symbol: s, quote: await getQuote(s) }; }
        catch(e){ return { symbol: s, quote: null }; }
      }));
      const quoteMap = new Map(results.map(r => [r.symbol, r.quote]));

      watchlistEl.innerHTML = "";
      for(const sym of syms){
        const q = quoteMap.get(sym);
        if(!profileCache.has(sym)) getProfile2(sym).then(refreshWatchlistNames).catch(()=>{});

        const row = document.createElement("div");
        row.className = "row";
        row.dataset.sym = sym;

        const name = profileCache.get(sym)?.name || "—";
        const dp = q ? pctFromQuote(q) : 0;

        row.innerHTML = `
          <div class="rowLeft"><b>${sym}</b><span>${name}</span></div>
          <div class="badge ${dp>=0?"up":"down"}">${q ? chgText(q) : "—"}</div>
        `;

        row.addEventListener("click", (e) => {
          if(e.shiftKey){
            selectedForRemoval = sym;
            [...watchlistEl.querySelectorAll(".row")].forEach(r => r.style.outline = "");
            row.style.outline = "2px solid rgba(239,68,68,.45)";
            return;
          }
          setUrlSymbol(sym);
        });

        const badgeEl = row.querySelector(".badge");
        if(badgeEl) badgeEl.addEventListener("click", (ev) => { ev.stopPropagation(); toggleDisplayMode(); });

        if(sym === selected) row.style.outline = "2px solid rgba(34,197,94,.45)";
        watchlistEl.appendChild(row);
      }

      if(selected){
        updateSelected(quoteMap.get(selected) || null, selected);
      } else if (syms[0]) {
        selected = syms[0];
        saveState();
        updateSelected(quoteMap.get(selected) || null, selected);
      } else {
        updateSelected(null, null);
      }

      const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      wlStatus.innerHTML = `Updated <b>${t}</b>.`;
    }

    function refreshWatchlistNames(){
      [...watchlistEl.querySelectorAll(".row")].forEach(r => {
        const sym = r.dataset.sym;
        const span = r.querySelector(".rowLeft span");
        if(span) span.textContent = profileCache.get(sym)?.name || "—";
      });
    }

    function timeAgo(tsSec){
      if(!tsSec) return "";
      const diff = Math.max(0, Math.floor(Date.now()/1000 - tsSec));
      if(diff < 60) return `${diff}s ago`;
      const m = Math.floor(diff/60);
      if(m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      return `${h}h ago`;
    }

    async function loadNews(){
      newsStatus.classList.remove("err");
      newsStatus.textContent = "Loading…";
      try{
        const data = await fetchJson("/news", { category: "general" });
        const items = Array.isArray(data) ? data.slice(0, 6) : [];
        newsEl.innerHTML = "";
        items.forEach(n => {
          const div = document.createElement("div");
          div.className = "newsItem";
          div.innerHTML = `
            <div class="newsMeta">
              <span class="time">${timeAgo(n.datetime)} • ${n.source || ""}</span>
              <span class="tag">${(n.category || "News").toUpperCase()}</span>
            </div>
            <b><a href="${n.url || "#"}" target="_blank" rel="noopener noreferrer">${n.headline || "Headline"}</a></b>
          `;
          newsEl.appendChild(div);
        });
        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        newsStatus.innerHTML = `Updated <b>${t}</b>.`;
      }catch(e){
        newsStatus.classList.add("err");
        newsStatus.textContent = `News error: ${e.message}`;
        newsEl.innerHTML = "";
      }
    }

    async function refreshAll(){
      wlStatus.classList.remove("err");
      try{
        await Promise.all([loadTopRows(), loadQuotesForWatchlist()]);
        if(Date.now() - lastNewsAt > NEWS_REFRESH_MS){
          await loadNews();
          lastNewsAt = Date.now();
        }
        if(Date.now() - lastBreakingAt > NEWS_REFRESH_MS){
          await loadBreaking();
          lastBreakingAt = Date.now();
        }
        if(selected && Date.now() - lastDriversAt > DRIVER_REFRESH_MS){
          const q = await getQuote(selected).catch(()=>null);
          await loadDriversForSymbol(selected, q, {
            summaryEl: document.getElementById('driversSummary'),
            listEl: document.getElementById('driversList'),
            statusEl: document.getElementById('selStatus')
          });
          lastDriversAt = Date.now();
        }
      }catch(e){
        wlStatus.classList.add("err");
        wlStatus.textContent = `Error: ${e.message}`;
      }
    }


    // -------------------------
    // Drivers + Breaking feeds
    // -------------------------
    const DRIVER_REFRESH_MS = 2 * 60 * 1000; // 2 min
    let lastDriversAt = 0;
    let lastBreakingAt = 0;

    function startOfTodaySec(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return Math.floor(d.getTime()/1000);
    }

    function scoreDriverHeadline(h){
      const t = String(h || "").toLowerCase();
      const keywords = [
        "earnings","guidance","revenue","profit","margin","forecast","outlook",
        "upgrade","downgrade","price target","pt","initiated","raised","cut",
        "sec","investigation","lawsuit","settlement","antitrust",
        "deal","partnership","acquire","acquisition","merger","m&a",
        "beats","misses","beats estimates","misses estimates",
        "layoffs","restructuring","buyback","dividend",
        "approval","fda","trial","recall","launch","release"
      ];
      let s = 0;
      keywords.forEach(k => { if(t.includes(k)) s += 2; });
      if(t.includes("earnings")) s += 3;
      if(t.includes("guidance") || t.includes("outlook")) s += 2;
      if(t.includes("upgrade") || t.includes("downgrade")) s += 2;
      if(t.includes("deal") || t.includes("acquir")) s += 2;
      return s;
    }

    async function getCompanyNews(symbol, fromSec, toSec){
      const fromD = new Date(fromSec*1000);
      const toD = new Date(toSec*1000);
      const f = fromD.toISOString().slice(0,10);
      const t = toD.toISOString().slice(0,10);
      return fetchJson("/company-news", { symbol: symbol.toUpperCase(), from: f, to: t });
    }

    function pickTopDrivers(items, limit=5){
      if(!Array.isArray(items)) return [];
      const ranked = items
        .filter(x => x && x.headline && x.url)
        .map(x => ({...x, _score: scoreDriverHeadline(x.headline) }))
        .sort((a,b) => (b._score - a._score) || ((b.datetime||0) - (a.datetime||0)));
      const out = [];
      const seen = new Set();
      for(const r of ranked){
        const key = String(r.headline).trim().toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push(r);
        if(out.length >= limit) break;
      }
      return out;
    }

    function renderDriversUI(ui, sym, q, drivers){
      if(!ui || !ui.summaryEl || !ui.listEl) return;
      const dp = q ? pctFromQuote(q) : 0;
      const dirClass = dp >= 0 ? "up" : "down";
      const dirWord = dp >= 0 ? "up" : "down";

      let summary = `Today ${sym} is <b class="${dirClass}">${dirWord}</b>${q ? ` (${fmtPct(dp)})` : ""}.`;
      summary += drivers.length ? " Headlines most likely driving the move:" : " No clear headline driver found — could be broader market/flow.";
      ui.summaryEl.innerHTML = summary;
      // Also show a compact 1-liner directly under the chart.
      const oneLinerEl = (sym === (selected||"")) ? document.getElementById("selMoveSummary") : document.getElementById("singleMoveSummary");
      if(oneLinerEl){
        const top = drivers && drivers.length ? drivers[0].headline : null;
        oneLinerEl.innerHTML = top ? `Top headline: <b>${top}</b>` : `No headline driver found for today — could be market-wide flow.`;
      }

      ui.listEl.innerHTML = "";
      drivers.forEach(n => {
        const div = document.createElement("div");
        div.className = "newsItem";
        div.innerHTML = `
          <div class="newsMeta">
            <span class="time">${timeAgo(n.datetime)} • ${n.source || ""}</span>
            <span class="tag">DRIVER</span>
          </div>
          <b><a href="${n.url}" target="_blank" rel="noopener noreferrer">${n.headline}</a></b>
        `;
        ui.listEl.appendChild(div);
      });

      if(ui.statusEl){
        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        ui.statusEl.innerHTML = `Updated <b>${t}</b>.`;
      }
    }

    async function loadDriversForSymbol(sym, q, ui){
      if(!sym) return;
      try{
        if(ui.statusEl){
          ui.statusEl.classList.remove("err");
          ui.statusEl.textContent = "Loading…";
        }
        const nowSec = Math.floor(Date.now()/1000);
        const fromSec = startOfTodaySec();
        const yFrom = fromSec - 24*60*60;

        const items = await getCompanyNews(sym, yFrom, nowSec);
        const drivers = pickTopDrivers(items, 5);

        renderDriversUI(ui, sym, q, drivers);
      }catch(e){
        if(ui.statusEl){
          ui.statusEl.classList.add("err");
          ui.statusEl.textContent = `Drivers error: ${e.message}`;
        }
        if(ui.summaryEl) ui.summaryEl.textContent = "—";
        if(ui.listEl) ui.listEl.innerHTML = "";
      }
    }

    function getBreakingCandidatesFromNews(generalNews, watchSyms){
      const syms = (watchSyms || []).map(s => s.toUpperCase());
      const out = [];
      if(Array.isArray(generalNews)){
        generalNews.forEach(n => {
          if(!n || !n.headline) return;
          const h = String(n.headline).toUpperCase();
          const hit = syms.find(s => h.includes(s));
          out.push({ ...n, _hit: hit || null });
        });
      }
      return out.sort((a,b)=> (b.datetime||0)-(a.datetime||0)).slice(0, 6);
    }

    
    async function loadBreaking(){
      const breakingEl = document.getElementById("breaking");
      const breakingStatus = document.getElementById("breakingStatus");
      if(!breakingEl || !breakingStatus) return;

      breakingStatus.classList.remove("err");
      breakingStatus.textContent = "Loading…";

      try{
        const data = await fetchJson("/news", { category: "general" });

        // Prefer headlines that mention your watchlist tickers.
        const all = Array.isArray(data) ? data : [];
        const tagged = all.map(n => {
          const h = String(n?.headline || "").toUpperCase();
          const hit = watchlist.map(s=>String(s).toUpperCase()).find(s => h.includes(s));
          return { ...n, _hit: hit || null };
        });

        let items = tagged.filter(x => x._hit).sort((a,b)=> (b.datetime||0)-(a.datetime||0)).slice(0, 6);

        // If nothing hits your watchlist, show a couple of general items so the box isn't empty.
        if(!items.length){
          items = tagged.sort((a,b)=> (b.datetime||0)-(a.datetime||0)).slice(0, 3).map(x => ({...x, _hit: "BREAKING"}));
        }

        breakingEl.innerHTML = "";
        items.forEach(n => {
          const div = document.createElement("div");
          div.className = "newsItem";
          const tag = n._hit ? n._hit : "BREAKING";
          div.innerHTML = `
            <div class="newsMeta">
              <span class="time">${timeAgo(n.datetime)} • ${n.source || ""}</span>
              <span class="tag">${String(tag).toUpperCase()}</span>
            </div>
            <b><a href="${n.url || "#"}" target="_blank" rel="noopener noreferrer">${n.headline || "Headline"}</a></b>
          `;
          breakingEl.appendChild(div);
        });

        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        breakingStatus.innerHTML = `Updated <b>${t}</b>.`;
      }catch(e){
        breakingStatus.classList.add("err");
        breakingStatus.textContent = `Breaking error: ${e.message}`;
        breakingEl.innerHTML = "";
      }
    }

    // Single stock
    async function loadSingleStock(sym){
      if(!sym) return;
      dashboardView.style.display = "none";
      singleView.style.display = "block";

      await refreshHeader();
      updateMarketStatus();

      selected = sym;
      if(!watchlist.includes(sym)) watchlist.unshift(sym);
      saveState();

      singleStatus.classList.remove("err");
      singleStatus.textContent = "";
      try{
        const [q, p] = await Promise.all([getQuote(sym), getProfile2(sym)]);
        const name = p?.name || "";
        singleTitle.textContent = `${sym}${name ? " — " + name : ""}`;
        singleSub.textContent = "Single-stock view (URL: ?symbol=XYZ).";

        singlePrice.textContent = fmtNum(q.c);
        const dp = pctFromQuote(q);
        singleChange.textContent = `${fmtNum(q.d)} (${fmtPct(dp)})`;
        singleChange.style.color = dp >= 0 ? "var(--green)" : "var(--red)";
        singleRange.textContent = `${fmtNum(q.l)} – ${fmtNum(q.h)}`;
        singlePrev.textContent = fmtNum(q.pc);
        const t = q.t ? new Date(q.t * 1000) : null;
        singleStatus.textContent = t ? `Last update: ${t.toLocaleString()}` : "";

        renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
        refreshInsightForSingle();
        await loadDriversForSymbol(sym, q, {
          summaryEl: document.getElementById('singleDriversSummary'),
          listEl: document.getElementById('singleDriversList'),
          statusEl: document.getElementById('singleStatus')
        });
        lastDriversAt = Date.now();
      }catch(e){
        singleStatus.classList.add("err");
        singleStatus.textContent = `Error: ${e.message}`;
        const ms2 = document.getElementById("singleMoveSummary"); if(ms2) ms2.textContent = "";
        renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
      }
    }

    function showDashboard(){ singleView.style.display = "none"; dashboardView.style.display = "block"; }
    function handleRoute(){
      const sym = getUrlSymbol();
      if(sym){
        loadSingleStock(sym);
      }else{
        showDashboard();
        refreshAll();
      }
    }

    function openFromSearch(){
      const raw = (tickerInput.value || "").trim().toUpperCase();
      if(!raw) return;
      if(!/^[A-Z\.]{1,10}$/.test(raw)) return;
      tickerInput.value = "";
      setUrlSymbol(raw);
    }

    // Events
    selTitle.style.cursor = "pointer";
    selTitle.addEventListener("click", () => { if(selected) setUrlSymbol(selected); });

    refreshBtn.addEventListener("click", () => {
      const sym = getUrlSymbol();
      if(sym) loadSingleStock(sym);
      else refreshAll();
    });
    refreshNewsBtn.addEventListener("click", () => { lastNewsAt = 0; loadNews(); });
    tickerBtn.addEventListener("click", openFromSearch);
    tickerInput.addEventListener("keydown", (e) => { if(e.key === "Enter") openFromSearch(); });

    removeBtn.addEventListener("click", () => {
      if(!selectedForRemoval){
        wlStatus.textContent = "Shift-click a watchlist row to mark it, then press Remove.";
        return;
      }
      watchlist = watchlist.filter(s => s !== selectedForRemoval);
      if(selected === selectedForRemoval) selected = watchlist[0] || null;
      selectedForRemoval = null;
      saveState();
      refreshAll();
    });

    backBtn.addEventListener("click", () => setUrlSymbol(null));
    window.addEventListener("popstate", handleRoute);

    window.addEventListener("resize", () => {
      const sym = getUrlSymbol();
      if(sym) renderDailyChart(sym, singleChartCanvas, singleChartStatusEl);
      else if(selected) renderDailyChart(selected, chartCanvas, chartStatusEl);
    });



    // Insight refresh buttons
    const refreshInsightBtn = document.getElementById("refreshInsight");
    const singleRefreshInsightBtn = document.getElementById("singleRefreshInsight");
    if(refreshInsightBtn) refreshInsightBtn.addEventListener("click", refreshInsightForSelected);
    if(singleRefreshInsightBtn) singleRefreshInsightBtn.addEventListener("click", refreshInsightForSingle);

    // Wire Drivers + Breaking controls
    const refreshDriversBtn = document.getElementById("refreshDrivers");
    const singleRefreshDriversBtn = document.getElementById("singleRefreshDrivers");
    const refreshBreakingBtn = document.getElementById("refreshBreaking");

    if(refreshBreakingBtn) refreshBreakingBtn.addEventListener("click", () => { lastBreakingAt = 0; loadBreaking(); });

    if(refreshDriversBtn) refreshDriversBtn.addEventListener("click", async () => {
      lastDriversAt = 0;
      if(selected){
        const q = await getQuote(selected).catch(()=>null);
        loadDriversForSymbol(selected, q, {
          summaryEl: document.getElementById("driversSummary"),
          listEl: document.getElementById("driversList"),
          statusEl: document.getElementById("selStatus")
        });
      }
    });

    if(singleRefreshDriversBtn) singleRefreshDriversBtn.addEventListener("click", async () => {
      const sym = getUrlSymbol();
      if(sym){
        const q = await getQuote(sym).catch(()=>null);
        loadDriversForSymbol(sym, q, {
          summaryEl: document.getElementById("singleDriversSummary"),
          listEl: document.getElementById("singleDriversList"),
          statusEl: document.getElementById("singleStatus")
        });
      }
    });


    // -------------------------
    // Insight builder (no AI call)
    // Builds Robinhood-style sections from Finnhub + basic calculations.
    // -------------------------

    function fmtDateShort(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
      }catch(_){ return iso || "—"; }
    }

    function daysFromNow(iso){
      try{
        const d = new Date(iso);
        const diff = d.getTime() - Date.now();
        return Math.round(diff / (24*60*60*1000));
      }catch(_){ return null; }
    }

    function pickSectorProxy(profile){
      const ind = String(profile?.finnhubIndustry || "").toLowerCase();
      if(ind.includes("semiconductor")) return { etf:"SOXX", label:"Semiconductors" };
      if(ind.includes("software")) return { etf:"IGV", label:"Software" };
      if(ind.includes("technology")) return { etf:"XLK", label:"Tech" };
      if(ind.includes("oil") || ind.includes("gas") || ind.includes("energy")) return { etf:"XLE", label:"Energy" };
      if(ind.includes("banks") || ind.includes("financial")) return { etf:"XLF", label:"Financials" };
      if(ind.includes("biotech") || ind.includes("pharmaceutical") || ind.includes("health")) return { etf:"XLV", label:"Health Care" };
      if(ind.includes("industrial")) return { etf:"XLI", label:"Industrials" };
      if(ind.includes("consumer")) return { etf:"XLY", label:"Consumer" };
      return { etf:"SPY", label:"Market" };
    }

    async function getEarningsWindow(symbol){
      const now = new Date();
      const from = new Date(now.getTime() - 120*24*60*60*1000);
      const to = new Date(now.getTime() + 120*24*60*60*1000);
      const f = from.toISOString().slice(0,10);
      const t = to.toISOString().slice(0,10);
      const data = await fetchJson("/calendar/earnings", { symbol: symbol.toUpperCase(), from: f, to: t });
      const arr = data?.earningsCalendar || [];
      // pick next upcoming (date >= today), otherwise most recent
      const today = new Date(); today.setHours(0,0,0,0);
      const upcoming = arr
        .filter(x => x?.date)
        .map(x => ({...x, _d: new Date(x.date)}))
        .sort((a,b)=> a._d - b._d);
      const next = upcoming.find(x => x._d >= today) || null;
      const prev = [...upcoming].reverse().find(x => x._d < today) || null;
      return { next, prev };
    }

    function section(title, text){
      return { title, text };
    }

    function headlineSentence(sym, q, topHeadline){
      const dp = q ? pctFromQuote(q) : 0;
      const move = `${sym} ${dp>=0 ? "up" : "down"} ${Math.abs(dp).toFixed(2)}%`;
      if(topHeadline?.headline){
        return `${move} as ${topHeadline.headline.replace(/[\s]+/g," ").trim()}.`;
      }
      return `${move} with no single headline dominating; could be broader market/flows.`;
    }

    function buildInsightTitle(sym, q, topHeadline){
      const dp = q ? pctFromQuote(q) : 0;
      const pct = q ? Math.abs(dp).toFixed(2) : "—";
      const dir = dp>=0 ? "rises" : "falls";
      if(topHeadline?.headline){
        return `${sym} ${dir} ${pct}% as ${topHeadline.headline}`;
      }
      return `${sym} ${dir} ${pct}% today`;
    }

    async function buildInsight(sym){
      if(!sym) return null;

      // Base info
      const [q, p] = await Promise.all([
        getQuote(sym).catch(()=>null),
        getProfile2(sym).catch(()=>({}))
      ]);

      const dp = q ? pctFromQuote(q) : 0;

      // News (today + yesterday)
      const nowSec = Math.floor(Date.now()/1000);
      const fromSec = startOfTodaySec() - 24*60*60;
      const newsItems = await getCompanyNews(sym, fromSec, nowSec).catch(()=>[]);
      const drivers = pickTopDrivers(newsItems, 6);
      const topHeadline = drivers[0] || (Array.isArray(newsItems) ? newsItems[0] : null);

      // Earnings
      const earnings = await getEarningsWindow(sym).catch(()=>({next:null,prev:null}));

      // Analysts
      const rec = await fetchJson("/stock/recommendation", { symbol: sym.toUpperCase() }).catch(()=>[]);
      const recLatest = Array.isArray(rec) && rec.length ? rec[0] : null;
      const pt = await fetchJson("/stock/price-target", { symbol: sym.toUpperCase() }).catch(()=>null);

      // Insider
      const fromIso = new Date(Date.now()-60*24*60*60*1000).toISOString().slice(0,10);
      const toIso = new Date().toISOString().slice(0,10);
      const insider = await fetchJson("/stock/insider-transactions", { symbol: sym.toUpperCase(), from: fromIso, to: toIso }).catch(()=>null);
      const insiderArr = insider?.data || [];
      const insiderLast = Array.isArray(insiderArr) && insiderArr.length ? insiderArr[0] : null;

      // Sector context
      const sector = pickSectorProxy(p);
      const sectorQuote = await getQuote(sector.etf).catch(()=>null);

      // Compose sections
      const blocks = [];

      // 1) Top driver / headline
      blocks.push(section("Top headline driver", headlineSentence(sym, q, topHeadline)));

      // 2) Upcoming earnings focus
      if(earnings?.next?.date){
        const d = daysFromNow(earnings.next.date);
        const when = (d != null && d >= 0) ? (d === 0 ? "today" : (d === 1 ? "tomorrow" : `in ${d} days`)) : "soon";
        const epsEst = (earnings.next.epsEstimate != null && earnings.next.epsEstimate !== "") ? `$${Number(earnings.next.epsEstimate).toFixed(2)}` : null;
        const revEst = (earnings.next.revenueEstimate != null && earnings.next.revenueEstimate !== "") ? `$${Number(earnings.next.revenueEstimate).toLocaleString()}` : null;
        let txt = `${sym} is scheduled to report earnings ${when} (${fmtDateShort(earnings.next.date)}).`;
        if(epsEst) txt += ` Analysts estimate EPS around ${epsEst}.`;
        if(revEst) txt += ` Revenue estimate is about ${revEst}.`;
        txt += ` Traders often re-price volatility into the event.`;
        blocks.push(section("Upcoming earnings focus", txt));
      } else if(earnings?.prev?.date){
        const epsA = earnings.prev.epsActual != null && earnings.prev.epsActual !== "" ? `$${Number(earnings.prev.epsActual).toFixed(2)}` : null;
        const epsE = earnings.prev.epsEstimate != null && earnings.prev.epsEstimate !== "" ? `$${Number(earnings.prev.epsEstimate).toFixed(2)}` : null;
        let txt = `${sym} last reported earnings on ${fmtDateShort(earnings.prev.date)}.`;
        if(epsA && epsE) txt += ` EPS was ${epsA} vs ${epsE} estimate.`;
        txt += ` Investors are watching guidance and margins for the next leg.`;
        blocks.push(section("Earnings context", txt));
      }

      // 3) Analyst price target / ratings
      if(recLatest || pt){
        const buy = recLatest?.buy ?? 0;
        const hold = recLatest?.hold ?? 0;
        const sell = recLatest?.sell ?? 0;
        const total = buy+hold+sell || null;
        const tilt = total ? (buy/total) : null;

        let txt = "";
        if(recLatest && total){
          txt += `Street ratings skew ${tilt >= 0.5 ? "positive" : "cautious"}: ${buy} Buy, ${hold} Hold, ${sell} Sell (latest month). `;
        }
        if(pt && pt.targetMean){
          txt += `Average price target is $${Number(pt.targetMean).toFixed(2)} (low $${Number(pt.targetLow||0).toFixed(2)} / high $${Number(pt.targetHigh||0).toFixed(2)}). `;
        }
        txt += `Revisions and upgrades/downgrades can move the stock quickly intraday.`;
        blocks.push(section("Analyst sentiment", txt.trim()));
      }

      // 4) Insider transactions
      if(insiderLast && insiderLast.name){
        const sh = insiderLast.share ?? insiderLast.shares ?? insiderLast.transactionShare ?? null;
        const typ = insiderLast.transactionType || insiderLast.transactionCode || "transaction";
        const nm = insiderLast.name;
        const dt = insiderLast.transactionDate || insiderLast.date || "";
        let txt = `${nm} reported an insider ${typ.toLowerCase()} ${dt ? `on ${fmtDateShort(dt)}` : ""}.`;
        if(sh != null && Number(sh) !== 0) txt += ` Reported shares: ${Number(sh).toLocaleString()}.`;
        txt += ` Insider activity is usually interpreted in context (planned sales vs discretionary).`;
        blocks.push(section("Insider activity", txt));
      }

      // 5) Broader look: sector/market
      if(sectorQuote){
        const sdp = pctFromQuote(sectorQuote);
        let txt = `${sector.label} (proxy ${sector.etf}) is ${sdp>=0 ? "up" : "down"} ${Math.abs(sdp).toFixed(2)}% today. `;
        txt += `${sym} is moving ${Math.abs(dp) >= Math.abs(sdp) ? "more" : "less"} than its sector, suggesting ${Math.abs(dp - sdp) > 0.8 ? "stock-specific" : "sector"} influence.`;
        blocks.push(section("Broader look: sector context", txt));
      }

      // If we have multiple strong company headlines, add 1 more "More headlines" block
      if(drivers.length >= 2){
        const h2 = drivers[1];
        const txt = `Also in focus: ${h2.headline}.`;
        blocks.push(section("More headlines", txt));
      }

      // Cap blocks to 5–6 like screenshot
      const finalBlocks = blocks.slice(0, 6);

      return { sym, q, p, dp, topHeadline, blocks: finalBlocks };
    }

    function renderInsightTo(wrap, data, opts){
      if(!wrap) return;
      const titleEl = document.getElementById(opts.titleId);
      const subEl = document.getElementById(opts.subId);
      const blocksEl = document.getElementById(opts.blocksId);

      if(!data){
        if(titleEl) titleEl.textContent = "—";
        if(subEl) subEl.textContent = "—";
        if(blocksEl) blocksEl.innerHTML = "";
        return;
      }

      const sym = data.sym;
      const dp = data.dp || 0;

      if(titleEl){
        titleEl.textContent = buildInsightTitle(sym, data.q, data.topHeadline);
        titleEl.classList.remove("up","down");
        titleEl.classList.add(dp>=0 ? "up" : "down");
      }

      if(subEl){
        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        subEl.textContent = `Updated ${t}`;
      }

      if(blocksEl){
        blocksEl.innerHTML = "";
        data.blocks.forEach(b => {
          const block = document.createElement("div");
          block.className = "insightBlock";
          block.innerHTML = `
            <div class="insightRail"></div>
            <div>
              <div class="insightHeading">${b.title}</div>
              <div class="insightText">${b.text}</div>
            </div>
          `;
          blocksEl.appendChild(block);
        });
      }
    }

    async function refreshInsightForSelected(){
      const wrap = document.getElementById("insightWrap");
      if(!selected) return;
      const data = await buildInsight(selected).catch(()=>null);
      renderInsightTo(wrap, data, { titleId:"insightTitle", subId:"insightSub", blocksId:"insightBlocks" });
    }

    async function refreshInsightForSingle(){
      const sym = getUrlSymbol();
      const wrap = document.getElementById("singleInsightWrap");
      if(!sym) return;
      const data = await buildInsight(sym).catch(()=>null);
      renderInsightTo(wrap, data, { titleId:"singleInsightTitle", subId:"singleInsightSub", blocksId:"singleInsightBlocks" });
    }


    // -------------------------
    // AI Insight (server-backed)
    // -------------------------
    async function fetchAiInsight(sym){
      const r = await fetch(`/api/insight?symbol=${encodeURIComponent(sym)}`);
      const data = await r.json();
      if(!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data;
    }

    function renderAiInsight(prefix, data){
      // prefix: "" (dashboard) or "single"
      const titleEl  = document.getElementById(prefix ? `${prefix}InsightTitle` : "insightTitle");
      const subEl    = document.getElementById(prefix ? `${prefix}InsightSub` : "insightSub");
      const blocksEl = document.getElementById(prefix ? `${prefix}InsightBlocks` : "insightBlocks");

      if(!titleEl || !subEl || !blocksEl) return;

      if(!data){
        titleEl.textContent = "—";
        subEl.textContent = "—";
        blocksEl.innerHTML = "";
        return;
      }

      titleEl.textContent = data.title || "—";
      titleEl.classList.remove("up","down");
      if(data.sentiment === "up") titleEl.classList.add("up");
      if(data.sentiment === "down") titleEl.classList.add("down");

      subEl.textContent = data.updatedLabel || "Updated now";

      blocksEl.innerHTML = "";
      (data.sections || []).forEach(s => {
        const block = document.createElement("div");
        block.className = "insightBlock";
        block.innerHTML = `
          <div class="insightRail"></div>
          <div>
            <div class="insightHeading">${s.heading || "—"}</div>
            <div class="insightText">${s.body || ""}</div>
          </div>
        `;
        blocksEl.appendChild(block);
      });

      // Optional: add citations as small links at bottom
      if(Array.isArray(data.citations) && data.citations.length){
        const cite = document.createElement("div");
        cite.className = "status";
        cite.style.marginTop = "10px";
        cite.innerHTML = `Sources: ` + data.citations.slice(0,4).map(c =>
          `<a href="${c.url}" target="_blank" rel="noopener noreferrer" style="text-decoration:none; border-bottom:1px dotted rgba(230,237,243,.35);">${c.label || "link"}</a>`
        ).join(" • ");
        blocksEl.appendChild(cite);
      }
    }

    async function refreshInsightForSelected(){
      if(!selected) return;
      const wrap = document.getElementById("insightWrap");
      if(!wrap) return;

      const titleEl = document.getElementById("insightTitle");
      const subEl   = document.getElementById("insightSub");
      const blocksEl= document.getElementById("insightBlocks");
      if(subEl) subEl.textContent = "Loading…";

      try{
        const data = await fetchAiInsight(selected);
        renderAiInsight("", data);
      }catch(e){
        if(titleEl) titleEl.textContent = `${selected} insight unavailable`;
        if(subEl) subEl.textContent = e.message;
        if(blocksEl) blocksEl.innerHTML = "";
      }
    }

    async function refreshInsightForSingle(){
      const sym = getUrlSymbol();
      if(!sym) return;
      const subEl = document.getElementById("singleInsightSub");
      if(subEl) subEl.textContent = "Loading…";

      try{
        const data = await fetchAiInsight(sym);
        renderAiInsight("single", data);
      }catch(e){
        const titleEl = document.getElementById("singleInsightTitle");
        const blocksEl= document.getElementById("singleInsightBlocks");
        if(titleEl) titleEl.textContent = `${sym} insight unavailable`;
        if(subEl) subEl.textContent = e.message;
        if(blocksEl) blocksEl.innerHTML = "";
      }
    }

    // Init
    wireChartControls();
    updateMarketStatus();
    setInterval(updateMarketStatus, 60 * 1000);

    loadState();
    refreshHeader();
    handleRoute();
    loadBreaking();
    refreshInsightForSelected();

    setInterval(async () => {
      await refreshHeader();
      updateMarketStatus();
      const sym = getUrlSymbol();
      if(sym) loadSingleStock(sym);
      else refreshAll();
    }, 60000);
  </script>
</body>
</html>
